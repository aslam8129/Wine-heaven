<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Page</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .bg-gold {
            background-color: #600018;
            color: white;
        }
        .bg-gold:hover {
            background-color: #800020;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 ">
    <%- include('../partials/userHeader.ejs') %>

    <!-- Address Modal -->
    <div id="addressModal" class="modal ">
        <div class="modal-content mt-20">
            <div class="flex justify-between items-center ">
           
                </div>
            </form>
            
        </div>
    </div>

    <div class="p-4">
        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 mt-20">
            <!-- Checkout Steps -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Recipient Section -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold">1. RECIPIENT</h2>
                      <a href="/newaddress">  <button  class="text-blue-600 hover:text-blue-700">Add a new address</button></a>
                    </div>

                    <form id="checkoutForm" action="/placeOrder" method="POST">
                        <!-- Loop through addresses -->
                        <% addresses.forEach((address, index) => { %>
                            <div class="border rounded-lg p-4 mb-4 <%= index > 0 ? 'hidden' : '' %> address-item">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium"><%= address.name %></p>
                                        <p class="text-gray-600"><%= address.address %></p>
                                        <p class="text-gray-600"><%= address.city %>, <%= address.state %> <%= address.pincode %></p>
                                    </div>
                                    <a href="/addres-edit/<%= address._id %>" 
                                        
                                    
                                    <button type="button" 
                                          
                                            class="text-blue-600 hover:text-blue-700">
                                        Edit
                                    </button> </a>
                                </div>
                                <div class="flex items-center mt-4 space-x-4">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="shipping_address" class="w-4 h-4 text-blue-600 border-gray-300 mr-2" 
                                               value="<%= address._id %>">
                                        <span>Ship to this address</span>
                                    </label>
                                </div>
                            </div>
                        <% }); %>

                        <!-- See More Addresses Button -->
                        <% if (addresses.length > 1) { %>
                            <button type="button" id="seeMoreAddressesBtn" 
                                    class="text-blue-600 hover:text-blue-700">
                                See more addresses
                            </button>
                        <% } %>

                        <!-- Payment Options Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6 mt-6">
                            <h2 class="text-xl font-semibold mb-6">2. PAYMENT METHOD</h2>
                            <div class="space-y-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="payment_method" class="w-4 h-4 text-blue-600 border-gray-300 mr-2" 
                                           value="Cash on Delivery">
                                    <span>Cash on Delivery</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="payment_method" class="w-4 h-4 text-blue-600 border-gray-300 mr-2" 
                                           value="Wallet">
                                    <span>Wallet</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="payment_method" class="w-4 h-4 text-blue-600 border-gray-300 mr-2" 
                                           value="UPI">
                                    <span>UPI</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="bg-gold text-white py-3 w-full rounded-lg transition-colors mt-4">
                            Continue
                        </button>
                    </form>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold mb-6">ORDER SUMMARY</h2>
                    <div class="space-y-4">
                        <div class="mb-4">
                            <span class="font-medium">Total Items: </span><%= orderSummary.items.length %>
                        </div>
                        <% orderSummary.items.forEach(item => { %>
                            <div class="flex items-center mb-4">
                                <img src="/uploads/<%= item.productId.images[0] %>" alt="<%= item.productId.name %>" 
                                     class="w-16 h-16 object-cover rounded-md mr-4">
                                <div>
                                    <p class="font-medium"><%= item.productId.name %></p>
                                    <p class="text-sm text-gray-600">Quantity: <%= item.productCount %></p>
                                    <p class="text-sm text-gray-600">Price:    <i class="fa-solid fa-indian-rupee-sign">  </i><%= item.productPrice.toFixed(2) %></p>
                                </div>
                            </div>
                        <% }) %>
                        <div class="flex justify-between">
                            <span>Price</span>
                            <span><i class="fa-solid fa-indian-rupee-sign"></i><%= orderSummary.subtotal ? orderSummary.subtotal.toFixed(2) : '0.00' %></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Shipping & Handling</span>
                            <span><i class="fa-solid fa-indian-rupee-sign"></i> 100.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Discount</span>
                            <span><i class="fa-solid fa-indian-rupee-sign"></i><%= orderSummary.discount.toFixed(0) %>.00</span>
                        </div>
                       
                        <div class="flex justify-between font-bold pt-4 border-t">
                            <span>Order Total</span>
                            <span><i class="fa-solid fa-indian-rupee-sign"></i><%= orderSummary.total ? orderSummary.total.toFixed(0) : '0.00' %>.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('addressModal');
        const addressForm = document.getElementById('addressForm');

        
        function closeModal() {
            modal.style.display = 'none';
        }

        function editAddress(id, name, address, city, state, pincode) {
            openAddressModal(true);
            document.getElementById('addressId').value = id;
            document.getElementById('name').value = name;
            document.getElementById('address').value = address;
            document.getElementById('city').value = city;
            document.getElementById('state').value = state;
            document.getElementById('pincode').value = pincode;
            addressForm.action = '/address/edit';
        }

        // See More Addresses functionality
        const seeMoreAddressesBtn = document.getElementById('seeMoreAddressesBtn');
        if (seeMoreAddressesBtn) {
            seeMoreAddressesBtn.addEventListener('click', function() {
                document.querySelectorAll('.address-item').forEach(item => {
                    item.classList.remove('hidden');
                });
                seeMoreAddressesBtn.style.display = 'none';
            });
        }

        // Form validation before checkout
        document.getElementById('checkoutForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const addressSelected = document.querySelector('input[name="shipping_address"]:checked');
            const paymentSelected = document.querySelector('input[name="payment_method"]:checked');

            if (!addressSelected) {
                Swal.fire({
                    icon: 'error',
                    title: 'Address Required',
                    text: 'Please select a shipping address',
                    confirmButtonColor: '#600018'
                });
                return;
            }

            if (!paymentSelected) {
                Swal.fire({
                    icon: 'error',
                    title: 'Payment Method Required',
                    text: 'Please select a payment method',
                    confirmButtonColor: '#600018'
                });
                return;
            }

            this.submit();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }
        // Frontend validation and modal handling
const addressValidation = {
    validateAddress: function(formData) {
        const errors = [];
        
        // Name validation
        const name = formData.get('name').trim();
        if (name.length < 3 || name.charAt(0) === ' ' || name.charAt(0) !== name.charAt(0).toUpperCase()) {
            errors.push('Name must be at least 3 characters long, cannot start with a space, and must start with an uppercase letter.');
        }

        // Address validation
        const address = formData.get('address').trim();
        if (address.length < 5) {
            errors.push('Address must be at least 5 characters long.');
        }

        // City validation
        const city = formData.get('city').trim();
        if (city.length < 3) {
            errors.push('City must be at least 3 characters long.');
        }

        // State validation
        const state = formData.get('state');
        if (!state) {
            errors.push('Please select a state.');
        }

        // Pincode validation
        const pincode = formData.get('pincode').trim();
        const pincodePattern = /^[1-9][0-9]{5}$/;
        if (!pincodePattern.test(pincode)) {
            errors.push('Pincode must be exactly 6 digits and cannot start with 0.');
        }

        return errors;
    },

    showError: function(errors) {
        Swal.fire({
            icon: 'error',
            title: 'Validation Error',
            html: errors.join('<br>'),
            confirmButtonColor: '#600018'
        });
    },

    showSuccess: function(message) {
        Swal.fire({
            icon: 'success',
            title: 'Success',
            text: message,
            confirmButtonColor: '#600018'
        });
    }
};


    </script>

    <%- include('../partials/userFooter.ejs') %>
</body>
</html>